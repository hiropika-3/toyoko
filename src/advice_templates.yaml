# advice_templates.yaml
# このテンプレは 6 指標を横断的に網羅します。
# 使える変数:
#   - dbfs           : 平均ラウドネス（dBFS, 0=最大, -∞=無音）
#   - clip_ratio     : クリップ（|x| > clip_level）の割合(0.0〜1.0)
#   - silence_ratio  : 無音相当(|x| < silence_thresh)の割合(0.0〜1.0)
#   - crest_factor   : ピーク / RMS（ダイナミクス指標、目安 2〜6）
#   - rms            : 実効値（振幅の平均パワー, 0.0〜）
#   - peak           : 最大振幅（0.0〜1.0）
#
# メモ:
# - 閾値は一般的な目安です。マイク/環境で最適値が変わるため運用で調整してください。
# - ルールは上から順に評価されるわけではありません（本アプリは全ヒットを列挙）。
#   似た条件が複数ヒットする場合は、上位ルールを少し厳しめ（より限定的）にすると重複が減ります。

sections:
  - heading: "都代子のフィードバック（テンプレート）"
    rules:
      # ── 音量（dbfs） ──────────────────────────────────────────────
      # dbfs は 0に近いほど大きい。-25〜-15 dBFS を目安にチューニング。
      - if: "dbfs < -32"  # 非常に小さい（収録ミスや入力ゲイン不足を疑うレベル）
        text: 
          - "声のボリュームがかなり小さいので、マイクに近づいて収録し直してね！"
          - "声量が弱いみたいよ。もう少しマイクに近づいて収録し直してね！"
          - "あれ？声小さいのかな。スマホのマイクにもっと近づいて収録してみてね。"
      - if: "dbfs >= -32 and dbfs < -25"  # やや小さめ
        text: 
          - "声が小さいので、もう少し大きな声で話してみて！"
          - "自分の声を耳で確認して。ちょっと大きいかな？というくらいのボリュームでもう一度やろう！"
          - "声が小さいみたい。口をしっかり開けて、大きな声でもう一度！"
      - if: "dbfs >= -25 and dbfs <= -15"  # ちょうど良い帯域
        text: 
          - "良い感じのボリュームです！この調子で続けてみて。"
          - "ちょうど良いボリュームの声ですね！この調子で安定した発声を続けましょう。"
          - "音量バランスOK！この調子で続けてみて。"
      - if: "dbfs > -15 and dbfs <= -10"  # やや大きめ
        text: 
          - "全体的に声がちょっと大きいかなぁ。強弱がある方が大切な言葉が生きますよ！"
          - "音量が少し大き過ぎるかな。"
          - "音量はやや大きめです。強調したい箇所以外は少し抑えて、耳あたりを整えましょう。"
      - if: "dbfs > -10"  # 大きすぎ（クリップ/歪み予備軍）
        text:
          - "かなり大きい音量です。音割れの原因になります。マイクから少し離れるか、入力レベルを下げてください。"

      # ── クリッピング（clip_ratio） ────────────────────────────────
      # clip_ratio は 0.0〜1.0。0.005 (0.5%) 程度でも聴感上は気になり得る。
      - if: "clip_ratio > 0.02"  # 2%以上
        text: 
          - "音割れが頻発しています。話す強さを抑え、録音レベルを下げるか、マイク距離を広げましょう。"
      - if: "clip_ratio > 0.005 and clip_ratio <= 0.02"
        text: 
          - "軽度の音割れがあります。強調語の前は少し間を取り、ピークが立ちすぎないよう意識しましょう。"
      - if: "clip_ratio <= 0.005"
        text: 
          - "音割れの兆候はほぼありません。適切にコントロールできています。"

      # ── 間（silence_ratio） ────────────────────────────────────────
      # silence_ratio は 0.0〜1.0。0.10〜0.35 くらいが目安（コンテンツに依存）。
      - if: "silence_ratio < 0.08"  # 間が極端に少ない
        text: 
          - "間が少ない傾向です。要点や新しい段落の前に0.3秒ほどの間を入れると、伝わりやすさが上がります。"
      - if: "silence_ratio >= 0.08 and silence_ratio < 0.15"
        text: 
          - "間はやや少なめです。キーワードの手前で息を整え、聞き手に“置いていかない”配慮を足しましょう。"
      - if: "silence_ratio >= 0.15 and silence_ratio <= 0.35"  # ちょうど良い帯域
        text: 
          - "間の取り方は良好です。話の区切りや強調点が伝わりやすくなっています。"
      - if: "silence_ratio > 0.35 and silence_ratio <= 0.6"
        text: 
          - "間がやや長い傾向です。文末で息を使い切らず、テンポを一定に保つ練習をしてみましょう。"
      - if: "silence_ratio > 0.6"  # 間が多すぎ（躊躇/台本迷い/環境要因）
        text:
          - "無音が多めです。台本の区切りに目印を入れる/視線誘導を整えるなどして、流れを滑らかにしましょう。"

      # ── ダイナミクス（crest_factor） ───────────────────────────────
      # crest_factor = peak / rms。低すぎ=フラット/押し付け、高すぎ=ピーキー/聞き疲れ。
      - if: "crest_factor < 2.0 and dbfs < -18"  # 小さめ音量でフラット
        text: 
          - "強弱が控えめです。キーワードの頭で少し張り、直後に0.2秒の間を置くと輪郭が出ます。"
      - if: "crest_factor < 2.0 and dbfs >= -18"  # 音量は十分だがフラット
        text: 
          - "抑揚が弱めです。文の山（主張）と谷（補足）を意識して、音程/音量を少し波打たせましょう。"
      - if: "crest_factor >= 2.0 and crest_factor <= 6.0"  # 目安帯
        text: 
          - "ダイナミクスは適正です。聞き手の集中を保つバランスが取れています。"
      - if: "crest_factor > 6.0"
        text: 
          - "抑揚が強めです。語尾が跳ねすぎると聞き疲れにつながるので、収め方を少し柔らかく。"

      # ── ノイズ/明瞭さのヒント（rms と peak の補助） ───────────────
      # rms と peak の関係は収音環境や雑音レベルの当たりを付ける補助に使う。
      - if: "rms < 0.01 and peak < 0.1"  # 信号全体が小さい（環境/設定問題の疑い）
        text: 
          - "入力自体がかなり小さいようです。マイク入力ゲイン/デバイス設定を確認し、距離も見直しましょう。"
      - if: "rms > 0.1 and dbfs < -20"  # 平均パワーに対し音量表示が小さい=環境ノイズ多めの疑い
        text: 
          - "環境ノイズが相対的に高い可能性があります。静かな場所での録音や、ポップガード/吸音の工夫を検討してください。"

      # ── ピーク（peak）単体での警告/確認 ───────────────────────────
      # peak は 0.0〜1.0。0.9超は危険域、0.2未満は小さすぎ。
      - if: "peak >= 0.95"
        text: 
          - "ピークが非常に高いです。クリップの一歩手前。最大全開の発声時はマイクとの距離を広げましょう。"
      - if: "peak >= 0.85 and peak < 0.95"
        text: 
          - "ピークが高めです。強調箇所でだけピークが立つのは効果的ですが、連発は避けましょう。"
      - if: "peak < 0.2 and dbfs < -28"
        text: 
          - "ピークも平均も低いです。収録環境か設定を見直し、もう少し近接してしっかり声を当てましょう。"

      # ── 複合チェック（軽い相関のみ。解釈はあくまで補助） ──────────
      - if: "dbfs > -12 and clip_ratio <= 0.005"  # 大きいのに割れていない→良いコントロール
        text: 
          - "大きめの声でも音割れを抑えられています。メリハリを保ちつつ、聞きやすさを維持できています。"
      - if: "dbfs < -28 and silence_ratio < 0.10"  # 小音量かつ詰め気味
        text: 
          - "小さい声でテンポも速めです。要点前に深呼吸→0.3秒の間で“届く密度”に整えましょう。"
      - if: "dbfs > -15 and silence_ratio > 0.35"  # 大音量だが間が多い→緊張/迷いの可能性
        text: 
          - "声量は十分ですが無音が多めです。台本の区切りに目印を入れて、流れを滑らかにしましょう。"

      # ── ポジティブ強化（どれかが良好なら） ─────────────────────
      - if: "dbfs >= -25 and dbfs <= -15"
        text: 
          - "音量レンジはとても良いです。聞き手にとって心地よい音圧帯をキープできています。"
      - if: "silence_ratio >= 0.15 and silence_ratio <= 0.35"
        text: 
          - "間のコントロールがうまくできています。内容の理解を助けるリズムです。"
      - if: "clip_ratio <= 0.005"
        text: 
          - "ピークのコントロールが良好です。自信を持って、強調ポイントをさらに際立たせていきましょう。"
